---
title: "Assay Library Report"
author: "Witold Wolski"
mailto: "wew@fgcz.ethz.ch"
date: "29 Jul 2015"
output: pdf_document
toc : true
---


# Generate Ion Libraries

## Parameters

```{r insallLatestversions, echo=FALSE, message=FALSE}
#library(devtools)
#install_github("wolski/prozor")
#install_github("fgcz/specL")
rm(list=ls())
library(prozor)
library(specL)

```

```{r prepareEnvLoadLibraries, echo=FALSE, message=FALSE}
R.Version()$version.string
library(specL)
packageVersion('specL')
```

Library generation is run with the following parameters:

```{r setparameters, echo=FALSE}
if(!exists("OUTPUTDIR")){
  OUTPUTDIR = "res.46573"
  WORKDIR = "temp.46573"
  FASTA_FILE <- "/usr/local/mascot/sequence/fgcz_9606_d/current/fgcz_9606_d_20140506.fasta"
  MAX_IONS <- 6
  MIN_IONS <- 6
  BLIB_FILTERED <- "blib.blib.filtered.db"
  BLIB_REDUNDANT <- "blib.blib.db"
  MZ_ERROR <- 0.8 # e.g for Q-Exactive
} else{
  print("NOW I am starting to rock!")
}

SPECLIBRARYRDATA = file.path(OUTPUTDIR, "specLLibrary.RData")
SWATH_LIBRARY <- file.path(OUTPUTDIR, "assay_library.tsv")
PEPPROTMAPPING <- file.path(OUTPUTDIR, "pepprot.tsv")

FRAGMENTIONMZRANGE <- c(300,1250)
FRAGMENTIONRANGE <- c(MIN_IONS,200)

ANNOTATEDRDATA <- file.path(WORKDIR,"Annotated.RData")
NON_REDUNDANT <- file.path(WORKDIR,BLIB_FILTERED)
REDUNDANT <- file.path(WORKDIR,BLIB_REDUNDANT)

if(TRUE){
cat("Set params SPECLIBRARYRDATA = ",SPECLIBRARYRDATA , "\n",
    " SWATH_LIBRARY = ", SWATH_LIBRARY, "\n", 
    " PEPPROTMAPPING = ",PEPPROTMAPPING , "\n",
    " ANNOTATEDRDATA = ",ANNOTATEDRDATA, "\n",
    " NON_REDUNDANT = ",NON_REDUNDANT , "\n",
    " REDUNDANT = ",REDUNDANT, "\n" )
}
```

```{r, echo=FALSE}
cat(" MZ_ERROR = ",MZ_ERROR, "\n",
    " FRAGMENTIONMZRANGE = ", FRAGMENTIONMZRANGE, "\n",
    " FRAGMENTIONRANGE = ",FRAGMENTIONRANGE, "\n",
    " FASTA_FILE = ", FASTA_FILE, "\n",
    " MAX_IONS = ", MAX_IONS, "\n",
    " MIN_IONS = ", MIN_IONS, "\n"
    )

```

```{r readDatabases, eval=TRUE, echo=FALSE, message=FALSE}
system.time( nonRedundantBlib <- read.bibliospec(NON_REDUNDANT) )
system.time( redundantBlib <- read.bibliospec(REDUNDANT) )
save(redundantBlib, file=file.path(WORKDIR,"redundant.Rdata"))
save(nonRedundantBlib, file=file.path(WORKDIR,"nonredundant.Rdata"))

```


Defined filtering function.

```{r defineFragmentFunction}
  fragmentIonFunctionUpTo3 <- function (b, y) {
  Hydrogen <- 1.007825
  Oxygen <- 15.994915
  Nitrogen <- 14.003074
  b1_ <- (b )
  y1_ <- (y )
  b2_ <- (b + Hydrogen) / 2
  y2_ <- (y + Hydrogen) / 2 
  return( cbind(b1_, y1_, b2_, y2_) )
}

```

```{r generateLibrary,echo=FALSE, message=FALSE}
load(file.path(WORKDIR,"redundant.Rdata"))
load(file.path(WORKDIR,"nonredundant.Rdata"))
#xx <- annotate.protein_id(nonRedundantBlib,file=FASTA_FILE)
```

```{r,echo=FALSE, message=FALSE, eval=TRUE}
specLibrary <- genSwathIonLib(data = nonRedundantBlib,
  data.fit = redundantBlib,
  max.mZ.Da.error = MZ_ERROR,
  topN = MAX_IONS,
  fragmentIonMzRange = FRAGMENTIONMZRANGE,
  fragmentIonRange = FRAGMENTIONRANGE,
  fragmentIonFUN = fragmentIonFunctionUpTo3)
save(specLibrary , file = SPECLIBRARYRDATA )

```

## Library Generation Summary

```{r,echo=FALSE}
load(SPECLIBRARYRDATA)
summary(specLibrary)
```

Total Number of PSM's with Mascot e score < 0.05, in your search is __`r length(redundantBlib)`__. The number of unique precurosors is __`r length(nonRedundantBlib)`__.

The size of the generated ion library is __`r length(specLibrary@ionlibrary)`__. 
That means that __`r length(specLibrary@ionlibrary)/length(nonRedundantBlib) *100`__ % of the unique precursors fullfilled the filtering criteria.

# Assigning identified precursors to proteins

```{r getPeptideProt, echo=FALSE, message=FALSE}
protpep = getProteinPeptideTable(specLibrary)

```

```{r prozor, echo=FALSE, message=FALSE, eval=TRUE }
library(prozor)
fasta = read.fasta(file = FASTA_FILE, as.string = TRUE, seqtype="AA")
spid <-grep("sp\\|",names(fasta))
fasta = fasta[spid]

protpepAnnot = annotatePeptides(protpep,fasta)
head(protpep)
save(protpepAnnot, file=file.path(OUTPUTDIR,"protprotpepAnnot.rda"))

```


```{r matrix, echo=FALSE}
load(file.path(OUTPUTDIR,"protprotpepAnnot.rda"))
```

## Annotate peptides

```{r, echo=FALSE, message=FALSE}
library(Matrix)

write.table(protpepAnnot,file=PEPPROTMAPPING,quote = FALSE, row.names = FALSE,sep="\t")

pepProtMatrix = prepareMatrix(protpepAnnot)

protPepAssingments = greedy(prepareMatrix(protpepAnnot,weighting="inverse"))
xx = cbind(names(protPepAssingments),protPepAssingments)

for(i in 1:length(specLibrary@ionlibrary)){
  specl <- specLibrary@ionlibrary[[i]]
  id <- paste(specl@peptideModSeq, specl@prec_z, sep="." )
  tmp = protPepAssingments[[id]]
  if(!is.null(tmp)){
    specLibrary@ionlibrary[[i]]@proteinInformation = tmp
  }
}

uniq <- rowSums(pepProtMatrix)
names(uniq)<-rownames(pepProtMatrix)
proteotyp<- table(uniq)

plot(proteotyp, ylab="nr peptides", xlab="matching number proteins", main="proteotypic")

tp <- unlist(protPepAssingments)
tmp<-((table(tp)))
tmp2 <- table(tmp)
plot(tmp2,ylab ="number of proteins",  xlab="number of precurosor assignments" , main="single hit wonders")

```

- Least specific peptide precursor : `r names(uniq)[which.max(uniq)]` matching 
`r max(uniq)` proteins.

- Protein with most peptide assignments (`r max(tmp)`) : `r names(tmp)[which.max(tmp)]`  


Number of annotated precursors is : __`r dim(pepProtMatrix)[1]`__.
There are in total __`r dim(protpepAnnot)[1]`__ precursor protein assingments.
There are __`r sum(uniq == 1)`__ proteotypic precursors, while __`r dim(pepProtMatrix)[1] - sum(uniq == 1)`__ where assigned to 2 or more protein sequences.

## Compute minimal protein set explaining peptides

The __`r dim(pepProtMatrix)[1]`__ peptide precursors matched protein sequences assigned to __`r dim(pepProtMatrix)[2]`__ unique protein identifies.

The minimal protein set explaining precursors has a size of __`r length(unique(unlist(protPepAssingments)))`__ proteins.

```{r writeSpecnaut, echo=FALSE, message=FALSE}
write.spectronaut(specLibrary,file=SWATH_LIBRARY)
tmp = read.table(file=SWATH_LIBRARY,header=TRUE,sep="\t")

```


# Summary

The file `assay_library.tsv` contains a spectronaut compatible assay library. The assays in this file are annotated with razor proteins.

